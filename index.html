<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ahorr√≥polis - Juego Educativo Financiero</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #D8E2DC; 
    }

    .board-container {
      max-width: 700px;
      margin: 1rem auto; 
      padding: 15px; 
      background-color: #3A5A40; 
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }

    .board {
      display: grid;
      grid-template-columns: 120px repeat(3, 1fr) 120px;
      grid-template-rows: 120px repeat(3, 1fr) 120px;
      gap: 5px; 
      background-color: #588157; 
      aspect-ratio: 1 / 1;
      position: relative;
      border: 3px solid #3A5A40; 
    }

    .tile {
      border: 2px solid #3A5A40; 
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-around; 
      font-size: 10px; 
      text-align: center;
      padding: 6px 4px;
      position: relative;
      overflow: hidden;
      min-height: 50px; 
      box-sizing: border-box;
    }

    .corner {
      font-weight: bold;
      font-size: 11px; 
    }

    .tile-green-dark { background-color: #588157; color: #FFFFFF; }
    .tile-beige { background-color: #F4EADE; color: #3A5A40; }
    .tile-green-light { background-color: #A3B18A; color: #1E2D2F; }

    .tile-name { font-weight: 700; margin-bottom: 3px; line-height: 1.1; font-size:11px; }
    .tile-icon { font-size: 26px; margin-bottom: 3px; line-height: 1;}
    .tile-subtext { font-size: 10px; font-weight: 600;}

    .player-container {
        position: absolute;
        inset: 0;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        pointer-events: none;
    }

    .player {
      position: absolute;
      font-size: 22px;
      transition: all 0.3s ease-in-out;
      z-index: 5;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
    }
    .player[data-player-index="0"] { transform: translate(-8px, -8px); }
    .player[data-player-index="1"] { transform: translate(8px, -8px); }
    .player[data-player-index="2"] { transform: translate(-8px, 8px); }
    .player[data-player-index="3"] { transform: translate(8px, 8px); }


    .center-area {
      grid-column: 2 / 5; 
      grid-row: 2 / 5;
      background-color: #A3B18A; 
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center; 
      border: 3px solid #3A5A40; 
      border-radius: 8px;
      padding: 10px;
      text-align: center;
    }

    .game-title-container {
        background-color: #F4EADE; 
        padding: 8px 18px; 
        border-radius: 6px; 
        border: 2px solid #3A5A40; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        margin-top: 10px; 
        margin-bottom: 10px; 
        display: inline-block; 
    }

    .game-title-main {
      font-size: 2.2rem; 
      font-weight: 800;
      color: #D4AF37; 
      text-shadow: 
        -1px -1px 0 #503D18,  
         1px -1px 0 #503D18,
        -1px  1px 0 #503D18,
         1px  1px 0 #503D18, 
         2px  2px 3px rgba(0,0,0,0.2); 
      margin: 0; 
      line-height: 1;
    }

    .center-iconography {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px; 
    }
    .center-piggybank { font-size: 30px; color: #FF8FAF; }
    .center-money-bills { font-size: 30px; color: #C1FF72; }
    .center-growth-chart { font-size: 30px; color: #7AD7F0; }


    .center-financial-terms {
        font-size: 0.65rem; 
        font-weight: 600;
        color: #2c3e50; 
        line-height: 1.3;
        border: 1px solid #588157; 
        padding: 4px 8px;
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.6); 
    }

    .center-action-circles {
        display: flex;
        gap: 8px;
        margin-bottom: 8px; 
    }
    .action-circle {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #D4AF37; 
        color: #3A5A40; 
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        font-weight: bold;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    #dice-display { 
        font-size: 2.2rem; 
        color: #FFFFFF; 
        text-shadow: 1px 1px 2px #3A5A40;
        margin-bottom: 5px; 
    }
    
    #roll-dice-button {
        width: 70px; 
        height: 70px; 
        border-radius: 50%; 
        background-color: #D4AF37; 
        color: #3A5A40; 
        font-weight: bold;
        font-size: 0.9rem; 
        border: 2px solid #3A5A40; 
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 0; 
        box-shadow: 0 3px 5px rgba(0,0,0,0.2);
        transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s ease-in-out;
        cursor: pointer;
        margin: 5px auto; 
    }

    #roll-dice-button:hover:not([disabled]) {
        background-color: #c8a02a; 
        transform: translateY(-1px); 
        box-shadow: 0 4px 7px rgba(0,0,0,0.25);
    }

    #roll-dice-button:active:not([disabled]) {
        transform: translateY(0px); 
        box-shadow: 0 2px 3px rgba(0,0,0,0.2);
    }

    #roll-dice-button:disabled {
        background-color: #a8935a; 
        color: #7a683f;
        cursor: not-allowed;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); 
    }

    #roll-result-display { 
        font-size: 0.9rem; 
        color: #FFFFFF; 
        text-shadow: 1px 1px 1px #3A5A40; 
        margin-top: 5px; 
        min-height: 1.2em;
    }

    .modal { display: none; }
    .modal.flex { display: flex; }

    #gameControls {
        text-align: center;
        margin-bottom: 1rem; 
    }

    #toggleMusicButton {
        background-color: #588157; 
        color: white;
        padding: 8px 15px;
        border-radius: 20px; 
        font-weight: 600;
        border: 2px solid #3A5A40;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        transition: background-color 0.2s, transform 0.1s;
    }
    #toggleMusicButton:hover:not([disabled]) {
        background-color: #3A5A40; 
        transform: translateY(-1px);
    }
    #toggleMusicButton:disabled {
        background-color: #a3b18a;
        color: #e0e0e0;
        cursor: not-allowed;
    }

    /* Responsive Adjustments */
    @media (max-width: 720px) { 
      .board-container { max-width: 95%; margin: 1rem auto; padding: 10px;}
      .board {
        grid-template-columns: 80px repeat(3, 1fr) 80px;
        grid-template-rows: 80px repeat(3, 1fr) 80px;
        gap: 3px;
      }
      .tile { font-size: 9px; padding: 4px 2px; min-height: 45px;}
      .corner { font-size: 10px; }
      .tile-icon { font-size: 20px; }
      .tile-name { font-size: 10px;}
      .tile-subtext { font-size: 9px; }

      .player { font-size: 16px; width: 16px; height: 16px; }
      .player[data-player-index="0"] { transform: translate(-5px, -5px); }
      .player[data-player-index="1"] { transform: translate(5px, -5px); }
      .player[data-player-index="2"] { transform: translate(-5px, 5px); }
      .player[data-player-index="3"] { transform: translate(5px, 5px); }
      
      .game-title-container { padding: 6px 12px; margin-top: 8px; margin-bottom: 8px;}
      .game-title-main { font-size: 1.5rem; }

      .center-iconography { gap: 8px; margin-bottom: 6px; }
      .center-piggybank, .center-money-bills, .center-growth-chart { font-size: 22px; }
      .center-financial-terms { font-size: 0.55rem; padding: 3px 6px; }
      .center-action-circles { gap: 6px; margin-bottom: 6px;}
      .action-circle { width: 22px; height: 22px; font-size: 0.8rem; }
      
      #dice-display { font-size: 1.8rem; }
      #roll-dice-button {
        width: 60px;
        height: 60px;
        font-size: 0.8rem;
      }
      #roll-result-display { font-size: 0.8rem; }
      .center-area { padding: 8px;}
    }
     @media (max-width: 480px) {
        .board {
            grid-template-columns: 60px repeat(3, 1fr) 60px;
            grid-template-rows: 60px repeat(3, 1fr) 60px;
        }
        .tile { min-height: 40px; }
        .tile-icon { font-size: 16px;}
        .tile-name { font-size: 8px;}
        .tile-subtext { font-size: 7px;}

        .game-title-container { padding: 5px 10px; margin-top: 6px; margin-bottom: 6px;}
        .game-title-main { font-size: 1.2rem; }

        .center-piggybank, .center-money-bills, .center-growth-chart { font-size: 18px; }
        .center-financial-terms { font-size: 0.5rem; }
        .action-circle { width: 18px; height: 18px; font-size: 0.7rem; }
        #roll-dice-button {
            width: 50px;
            height: 50px;
            font-size: 0.7rem;
        }
     }

  </style>
</head>
<body class="text-gray-800">

  <nav class="bg-[#588157] p-3 text-white flex justify-center gap-5 shadow-md">
    <a href="#" onclick="mostrarPestana('inicio')" class="hover:underline font-semibold">Inicio</a>
    <a href="#" onclick="mostrarPestana('reglas')" class="hover:underline font-semibold">Reglas</a>
    <a href="#" onclick="mostrarPestana('juego')" class="hover:underline font-semibold">Jugar</a>
  </nav>

  <header class="bg-[#3A5A40] p-5 text-center text-white shadow-lg">
    <h1 class="text-3xl font-bold">Ahorr√≥polis</h1> 
  </header>

  <main class="p-5">
    <section id="pestana-inicio" class="bg-white p-5 rounded-lg shadow mb-6">
      <h2 class="text-2xl font-semibold text-[#3A5A40] mb-3">Bienvenido a Ahorr√≥polis</h2>
      <p>Un juego educativo para aprender finanzas personales mientras te diviertes.</p>
      <p class="mt-2">¬°Prep√°rate para tomar decisiones financieras inteligentes y alcanzar la meta!</p>
      <p class="mt-4 italic">Cuando est√©s listo, haz clic en "Jugar" en la barra de navegaci√≥n superior.</p>
    </section>

    <section id="pestana-reglas" style="display:none;" class="bg-white p-5 rounded-lg shadow mb-6">
      <h2 class="text-2xl font-semibold text-[#3A5A40] mb-3">Reglas del Juego</h2>
      <ul class="list-disc list-inside space-y-1">
        <li>Cada jugador empieza con $1000 (¬°un buen capital inicial!).</li>
        <li>Se avanza lanzando un dado (1-6).</li>
        <li>El tablero tiene diversas casillas con efectos financieros. ¬°Presta atenci√≥n!</li>
        <li>Completa 2 vueltas al tablero para terminar (pasar por la casilla "SALIDA" dos veces despu√©s de la inicial).</li>
        <li>Gana quien tenga m√°s dinero al finalizar.</li>
        <li>Algunas casillas presentan retos o eventos sorpresa.</li>
      </ul>
    </section>

    <section id="pestana-juego" style="display:none;">
      <div id="playerSetup" class="bg-white p-5 rounded-lg shadow mb-6 text-center">
          <h3 class="text-xl font-semibold text-[#3A5A40] mb-3">Configuraci√≥n de Jugadores</h3>
          <div id="playerInputsContainer" class="mb-4">
              <div class="flex items-center justify-center mb-2">
                  <input type="text" class="playerNameInput border rounded px-3 py-2 mr-2 w-60 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Nombre del Jugador 1">
                  <span class="player-icon-selector text-2xl cursor-pointer p-1 bg-gray-200 rounded" onclick="selectIcon(this)">üöó</span>
              </div>
          </div>
          <button onclick="addPlayerInput()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded mr-2 transition duration-150 ease-in-out">+</button>
          <button id="startGame" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out">Iniciar Juego</button>
      </div>

      <div id="gameArea" style="display: none;">
          <div id="gameControls" class="text-center mt-2 mb-4"> 
              <button id="toggleMusicButton" disabled>‚ñ∂Ô∏è M√∫sica</button>
              <audio id="backgroundMusicPlayer" loop src="https://cdn.discordapp.com/attachments/929497791980511264/1370863427966468248/backgroundbg.MP3?ex=68210b8e&is=681fba0e&hm=765e9f89147915475e70db7db804f9f7338265367baf201ba47b1fb2568eed01&"></audio> 
              <audio id="diceSoundPlayer" src="https://cdn.discordapp.com/attachments/929497791980511264/1370862309387538452/dicesound.MP3?ex=68210a83&is=681fb903&hm=64925a44a1999a5f5e77773b82b2ea88e6431403f394feb4398d946dc84d6c25&"></audio>
          </div>
          <div class="board-container">
              <div id="board" class="board">
                  </div>
          </div>

          <div id="turnoActual" class="text-center mt-4 text-lg font-semibold text-[#3A5A40]"></div>
          <div id="playersStatus" class="flex flex-wrap justify-center gap-4 mt-4">
              </div>
      </div>
    </section>
  </main>

  <footer class="bg-[#3A5A40] text-white text-center p-4 mt-10">
    &copy; 2025 Ahorr√≥polis - Juego Financiero
  </footer>

  <div id="victoriaModal" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 items-center justify-center z-50">
    <div class="modal-content bg-white p-6 rounded-lg shadow-xl text-center max-w-sm w-full">
      <h2 class="text-2xl font-bold text-yellow-500 mb-4">üéâ ¬°Felicidades! üéâ</h2>
      <p id="mensajeVictoria" class="mb-5"></p>
      <button onclick="location.reload()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out">Jugar de nuevo</button>
    </div>
  </div>

  <div id="challengeModal" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 items-center justify-center z-50">
    <div class="modal-content bg-white p-6 rounded-lg shadow-xl text-center max-w-md w-full">
      <h2 class="text-xl font-semibold text-blue-700 mb-4">üéØ ¬°Reto Financiero! üéØ</h2>
      <p id="challengeQuestion" class="mb-5"></p>
      <div id="challengeOptions" class="options space-y-3">
          </div>
    </div>
  </div>

  <div id="iconSelectorModal" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 items-center justify-center z-50">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl text-center max-w-md w-full">
            <h2 class="text-xl font-semibold mb-4">Elige tu Icono</h2>
            <div id="iconOptions" class="grid grid-cols-4 sm:grid-cols-6 gap-4 text-3xl">
                </div>
            <button onclick="closeIconSelector()" class="mt-5 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out">Cerrar</button>
        </div>
    </div>


  <script>
    const boardDiv = document.getElementById("board");
    let rollButton; 
    let diceDiv;    
    let resultDiv;  
    const playerInputsContainer = document.getElementById("playerInputsContainer");
    const playersStatusDiv = document.getElementById("playersStatus");
    const turnoActualDiv = document.getElementById("turnoActual");
    const victoriaModal = document.getElementById("victoriaModal");
    const mensajeVictoria = document.getElementById("mensajeVictoria");
    const challengeModal = document.getElementById("challengeModal");
    const questionEl = document.getElementById("challengeQuestion");
    const optionsEl = document.getElementById("challengeOptions");
    const playerSetupDiv = document.getElementById("playerSetup");
    const gameAreaDiv = document.getElementById("gameArea");
    const iconSelectorModal = document.getElementById("iconSelectorModal");
    const iconOptionsDiv = document.getElementById("iconOptions");
    const startButton = document.getElementById("startGame");
    const toggleMusicButton = document.getElementById('toggleMusicButton');
    const backgroundMusicPlayer = document.getElementById('backgroundMusicPlayer'); 
    const diceSoundPlayer = document.getElementById('diceSoundPlayer'); // HTML Audio for dice

    let players = [];
    let currentPlayerIndex = 0;
    let diceLocked = false;
    let currentIconTarget = null;
    const availableIcons = ['üöó', 'üöÄ', '‚õµ', 'üö≤', 'üöÅ', 'üõ∏', 'üöÇ', 'üõµ', 'üö¢', 'üèéÔ∏è', 'üèçÔ∏è', 'üõ¥', 'üí∞', 'üíé', 'üé©', 'üê∂', 'üê±', 'ü§ñ'];

    // Audio variables
    let moveSynth; // Only moveSynth from Tone.js
    let soundsInitialized = false; 

    const tiles = [
      { name: "SALIDA", icon: "üíé", type: 'corner', 
        effect: player => { 
            if (player.laps > 0 && !player.justGotGoBonusThisTurn) { 
                player.money += 200; 
                showMessage(`${player.name} ${player.position === 0 ? 'aterriz√≥ en' : 'pas√≥ por'} Salida y cobr√≥ $200!`, 'success');
                player.justGotGoBonusThisTurn = true; 
            }
        }, 
        colorClass: 'tile-green-dark' 
      },
      { name: "GASTO", subtext: "-$150", icon: "üè†", effect: player => { player.money -= 150; showMessage(`${player.name} pag√≥ $150 por gastos del hogar.`, 'warning'); }, colorClass: 'tile-beige' },
      { name: "INVERSI√ìN", subtext: "Propiedad", icon: "üè°", effect: player => { showMessage(`${player.name} considera una inversi√≥n inmobiliaria.`, 'info'); }, colorClass: 'tile-green-light' },
      { name: "SORPRESA", icon: "üéÅ", effect: player => { player.money += 75; showMessage(`${player.name} encontr√≥ un regalo: +$75!`, 'success'); }, colorClass: 'tile-beige' },
      { name: "RIESGO", icon: "‚ìá", type: 'corner', effect: player => { const gain = Math.random() > 0.6 ? 150 : -75; player.money += gain; showMessage(`${player.name} tom√≥ un riesgo y ${gain > 0 ? 'gan√≥ $' + gain : 'perdi√≥ $' + Math.abs(gain)}.`, gain > 0 ? 'success' : 'danger');}, colorClass: 'tile-green-dark' },
      { name: "RECOMPENSA", icon: "üåø", subtext: "+$100", effect: player => { player.money += 100; showMessage(`${player.name} obtuvo una recompensa de $100.`, 'success'); }, colorClass: 'tile-beige' },
      { name: "MANTENIMIENTO", icon: "üõ†Ô∏è", subtext: "-$50", effect: player => { player.money -= 50; showMessage(`${player.name} pag√≥ $50 por mantenimiento.`, 'warning'); }, colorClass: 'tile-green-light' },
      { name: "EVENTO", icon: "‚ùì", type: 'surprise', effect: player => handleSurprise(player), colorClass: 'tile-beige' },
      { name: "BONIFICACI√ìN", icon: "üí∞", type: 'corner', effect: player => { player.money += 120; showMessage(`${player.name} recibi√≥ una bonificaci√≥n de $120!`, 'success'); }, colorClass: 'tile-green-dark' },
      { name: "IMPUESTOS", icon: "üßæ", subtext: "-$100", effect: player => { player.money -= 100; showMessage(`${player.name} pag√≥ $100 de impuestos.`, 'danger'); }, colorClass: 'tile-beige' },
      { name: "DESAF√çO", icon: "‚ùì", type: 'challenge', effect: player => triggerChallenge(player), colorClass: 'tile-green-light' },
      { name: "OPORTUNIDAD", icon: "‚ùî", effect: player => { const amount = Math.random() > 0.5 ? 60 : -30; player.money += amount; showMessage(`${player.name} encontr√≥ una oportunidad! (${amount > 0 ? '+' : ''}$${amount})`, 'info');}, colorClass: 'tile-beige' },
      { name: "DEUDAS", icon: "‚öñÔ∏è", type: 'corner', effect: player => { player.money -= 80; showMessage(`${player.name} pag√≥ deudas por $80.`, 'danger'); }, colorClass: 'tile-green-dark' },
      { name: "INGRESOS EXTRA", icon: "üí≤", subtext: "+$150", effect: player => { player.money += 150; showMessage(`${player.name} gener√≥ ingresos extra de $150.`, 'success'); }, colorClass: 'tile-beige' },
      { name: "AHORROS", icon: "ü™ô", subtext: "+$100", effect: player => { player.money += 100; showMessage(`${player.name} increment√≥ sus ahorros en $100.`, 'success'); }, colorClass: 'tile-green-light' },
      { name: "DESAF√çOS FIN.", icon: "üß©", type: 'challenge', effect: player => triggerChallenge(player), colorClass: 'tile-beige' },
    ];
    const totalTiles = tiles.length;
    const START_MONEY = 1000;

    // --- Audio Functions ---
    async function initAudio() {
        if (soundsInitialized) return;
        try {
            await Tone.start(); 
            console.log("Audio Context for SFX started successfully!");
            soundsInitialized = true; 

            moveSynth = new Tone.MembraneSynth({
                pitchDecay: 0.01, octaves: 3, oscillator: { type: "sine" },
                envelope: { attack: 0.001, decay: 0.15, sustain: 0, release: 0.05 },
                volume: -15
            }).toDestination();

            if (toggleMusicButton) toggleMusicButton.disabled = false;

        } catch (e) {
            console.error("Error starting Audio Context for SFX:", e);
            if (toggleMusicButton) toggleMusicButton.disabled = true;
        }
    }

    function playDiceSound() {
        // Play custom dice sound using HTML audio element
        if (diceSoundPlayer) {
            diceSoundPlayer.currentTime = 0; // Rewind to start if already playing
            diceSoundPlayer.play().catch(e => console.error("Error playing dice sound:", e));
        }
    }

    function playMoveSound() {
        if (soundsInitialized && moveSynth) {
            moveSynth.triggerAttackRelease("G2", "16n", Tone.now() + Math.random() * 0.05);
        }
    }

    if (toggleMusicButton && backgroundMusicPlayer) {
        toggleMusicButton.addEventListener('click', () => {
            if (backgroundMusicPlayer.paused) {
                backgroundMusicPlayer.play().catch(e => console.error("Error playing music:", e));
                toggleMusicButton.textContent = "‚è∏Ô∏è M√∫sica";
            } else {
                backgroundMusicPlayer.pause();
                toggleMusicButton.textContent = "‚ñ∂Ô∏è M√∫sica";
            }
        });
    }

    function mostrarPestana(id) {
      document.getElementById('pestana-inicio').style.display = 'none';
      document.getElementById('pestana-reglas').style.display = 'none';
      document.getElementById('pestana-juego').style.display = 'none';
      const pestana = document.getElementById('pestana-' + id);
      if (pestana) pestana.style.display = 'block';
      if (id === 'juego') {
        if (players.length === 0) {
          playerSetupDiv.style.display = 'block';
          gameAreaDiv.style.display = 'none';
        } else {
          playerSetupDiv.style.display = 'none';
          gameAreaDiv.style.display = 'block';
        }
      }
    }

    function selectIcon(element) {
        currentIconTarget = element;
        iconOptionsDiv.innerHTML = '';
        availableIcons.forEach(icon => {
            const iconSpan = document.createElement('span');
            iconSpan.textContent = icon;
            iconSpan.className = 'cursor-pointer hover:opacity-75 p-2 rounded bg-gray-100 hover:bg-gray-200';
            iconSpan.onclick = () => {
                if (currentIconTarget) {
                    currentIconTarget.textContent = icon;
                    currentIconTarget.classList.remove('bg-gray-200');
                    currentIconTarget.classList.add('bg-green-100');
                }
                closeIconSelector();
            };
            iconOptionsDiv.appendChild(iconSpan);
        });
        iconSelectorModal.style.display = "flex";
    }

    function closeIconSelector() {
        iconSelectorModal.style.display = "none";
        currentIconTarget = null;
    }

    function addPlayerInput() {
        const count = playerInputsContainer.children.length + 1;
        if (count > 4) { showMessage("M√°ximo 4 jugadores.", "warning"); return; }
        const div = document.createElement('div');
        div.className = 'flex items-center justify-center mb-2';
        const defaultIcon = availableIcons[count - 1] || '‚ùì';
        div.innerHTML = `
            <input type="text" class="playerNameInput border rounded px-3 py-2 mr-2 w-60 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Nombre del Jugador ${count}">
            <span class="player-icon-selector text-2xl cursor-pointer p-1 bg-gray-200 rounded" onclick="selectIcon(this)">${defaultIcon}</span>
        `;
        playerInputsContainer.appendChild(div);
    }

    function renderBoard() {
      boardDiv.innerHTML = ""; 
      const centerArea = document.createElement('div');
      centerArea.className = 'center-area';
      centerArea.innerHTML = `
          <div class="center-iconography">
              <span class="center-money-bills">üíµ</span>
              <span class="center-piggybank">üê∑</span>
              <span class="center-growth-chart">üìà</span>
          </div>
          <div class="center-financial-terms">
              INGRESOS<br>GASTOS<br>INVERSI√ìN<br>AHORROS
          </div>
          <div class="game-title-container">
            <h2 class="game-title-main">AHORR√ìPOLIS</h2>
          </div>
          <div class="center-action-circles">
              <div class="action-circle">?</div>
              <div class="action-circle">$</div>
              <div class="action-circle">$</div>
          </div>
          <div id="dice-display">üé≤</div>
          <button id="roll-dice-button" disabled>Lanzar</button>
          <div id="roll-result-display"></div>
      `;
      boardDiv.appendChild(centerArea);

      tiles.forEach((tile, i) => {
        const div = document.createElement("div");
        div.className = `tile ${tile.type === 'corner' ? 'corner' : ''} ${tile.colorClass || 'tile-beige'}`;
        div.dataset.tileId = i;
        div.innerHTML = `
            <div class="tile-icon">${tile.icon}</div>
            <div class="tile-name">${tile.name}</div>
            ${tile.subtext ? `<div class="tile-subtext">${tile.subtext}</div>` : ''}
            <div class="player-container"></div>`;
        const { col, row } = getGridPosition(i);
        div.style.gridColumn = col;
        div.style.gridRow = row;
        boardDiv.appendChild(div);
      });

      diceDiv = document.getElementById('dice-display');
      rollButton = document.getElementById('roll-dice-button');
      resultDiv = document.getElementById('roll-result-display');
      
      if (rollButton) {
          rollButton.addEventListener('click', rollDice);
          rollButton.disabled = true; 
      }
    }

    function getGridPosition(index) {
        const boardSize = 5; 
        const tilesPerSide = boardSize - 1; 
        if (index < boardSize) { 
            return { col: `${index + 1} / ${index + 2}`, row: '1 / 2' };
        }
        else if (index < boardSize + tilesPerSide -1) { 
             return { col: `${boardSize} / ${boardSize + 1}`, row: `${(index - boardSize) + 2} / ${(index - boardSize) + 3}` };
        }
        else if (index < boardSize + (tilesPerSide*2) -1 ) { 
             if(index === (boardSize-1)*2) return { col: `${boardSize} / ${boardSize + 1}`, row: `${boardSize} / ${boardSize + 1}` };
            return { col: `${boardSize - (index - (boardSize-1)*2)} / ${boardSize - (index - (boardSize-1)*2) + 1}`, row: `${boardSize} / ${boardSize + 1}` };
        }
        else { 
            if(index === (boardSize-1)*3) return { col: `1 / 2`, row: `${boardSize} / ${boardSize + 1}` };
            return { col: '1 / 2', row: `${boardSize - (index - (boardSize-1)*3)} / ${boardSize - (index - (boardSize-1)*3) + 1}` };
        }
    }

    async function startGame() { 
      players = [];
      const inputDivs = playerInputsContainer.querySelectorAll("div.flex");
      inputDivs.forEach((div, i) => {
          const input = div.querySelector(".playerNameInput");
          const iconSpan = div.querySelector(".player-icon-selector");
          const name = input ? input.value.trim() : '';
          const icon = iconSpan ? iconSpan.textContent : '';
          if (name && icon && icon !== '‚ùì') {
              players.push({
                  name, position: 0, money: START_MONEY, correct: 0, wrong: 0,
                  pawn: null, icon: icon, laps: 0, id: `player-${i}`,
                  justGotGoBonusThisTurn: false 
              });
          } else { showMessage(`Jugador ${i+1} necesita nombre e icono.`, 'warning');}
      });

      if (players.length < 1) { showMessage("Agrega al menos un jugador.", "warning"); return; }
      playerSetupDiv.style.display = "none";
      renderBoard(); 
      await initAudio(); 
      players.forEach((player, i) => {
          const pawn = document.createElement("div");
          pawn.className = "player";
          pawn.textContent = player.icon;
          pawn.dataset.playerId = player.id;
          pawn.dataset.playerIndex = i; 
          player.pawn = pawn;
          movePlayer(player, true); 
      });
      gameAreaDiv.style.display = "block";
      currentPlayerIndex = 0;
      diceLocked = false;
      updateStatus();
      showTurn(); 
      mostrarPestana('juego');
    }

    function showTurn() {
      if (!players || players.length === 0) return;
      const player = players[currentPlayerIndex];
      if (!player) return;
      turnoActualDiv.textContent = `Turno de: ${player.name} ${player.icon}`;
      turnoActualDiv.style.color = getPlayerColor(currentPlayerIndex);
      if (rollButton) rollButton.disabled = diceLocked;
      if (resultDiv) resultDiv.textContent = '';
      if (diceDiv) diceDiv.textContent = 'üé≤';
    }

    function getPlayerColor(index) {
        const colors = ["#E53E3E", "#3182CE", "#38A169", "#DD6B20"];
        return colors[index % colors.length];
    }

    function rollDice() {
      if (diceLocked || !players.length) return;
      let player = players[currentPlayerIndex];
      if (!player) return;
      player.justGotGoBonusThisTurn = false; 
      diceLocked = true; 
      rollButton.disabled = true;
      playDiceSound(); // Play custom dice sound
      const roll = Math.floor(Math.random() * 6) + 1;
      diceDiv.textContent = `üé≤${roll}`;
      resultDiv.textContent = `Avanzando ${roll}...`;
      let initialPosition = player.position; 
      let currentAnimatedPosition = player.position; 
      let stepsTaken = 0;
      function stepAnimation() {
          if (stepsTaken < roll) {
              currentAnimatedPosition = (currentAnimatedPosition + 1) % totalTiles;
              movePlayer(player, false, currentAnimatedPosition);
              playMoveSound(); 
              stepsTaken++;
              setTimeout(stepAnimation, 250); 
          } else {
              player.position = currentAnimatedPosition; 
              if (initialPosition + roll >= totalTiles) { 
                  player.laps++;
                  if (tiles[0].effect && !player.justGotGoBonusThisTurn) { 
                     tiles[0].effect(player); 
                  }
              }
              const tile = tiles[player.position];
              resultDiv.textContent = `Cay√≥ en: ${tile.name}`;
              executeTileEffect(player, tile);
          }
      }
      stepAnimation();
    }

    function executeTileEffect(player, tile) {
        if (tile.effect) {
            tile.effect(player);
        }
        updateStatus(); 
        if (tile.type === 'challenge' || tile.type === 'surprise') {
            // nextTurn() is called within triggerChallenge or after handleSurprise
        } else {
            setTimeout(nextTurn, 1500);
        }
    }

    function movePlayer(player, instant = false, targetPos = player.position) {
        if (!player || !player.pawn) return;
        const tileElement = boardDiv.querySelector(`.tile[data-tile-id="${targetPos}"] .player-container`);
        if (tileElement) {
            player.pawn.style.transition = instant ? 'none' : 'all 0.25s ease-in-out';
            tileElement.appendChild(player.pawn);
            if (instant) void player.pawn.offsetWidth;
        }
    }

    function nextTurn() {
        const allFinished = players.every(p => p.laps >= 2); 
        if (allFinished && players.length > 0) {
            endGame();
            return;
        }
        currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
        diceLocked = false;
        showTurn();
    }

    function endGame() {
        diceLocked = true; 
        if(rollButton) rollButton.disabled = true;
        
        if (backgroundMusicPlayer && !backgroundMusicPlayer.paused) {
            backgroundMusicPlayer.pause();
        }
        if(toggleMusicButton) toggleMusicButton.textContent = "‚ñ∂Ô∏è M√∫sica";

        const sortedPlayers = [...players].sort((a, b) => b.money - a.money);
        const topPlayer = sortedPlayers[0];
        let rankingText = sortedPlayers.map((p, index) =>
            `${index + 1}. ${p.name} ${p.icon}: $${p.money} (${p.laps} vueltas)`
        ).join('<br>');
        mensajeVictoria.innerHTML = `<strong>¬°Juego terminado!</strong><br><br>${topPlayer.name} ${topPlayer.icon} gan√≥ con $${topPlayer.money}.<br><br><strong>Ranking Final:</strong><br>${rankingText}`;
        victoriaModal.style.display = "flex";
    }

    function updateStatus() {
      playersStatusDiv.innerHTML = "";
      players.forEach((player, index) => {
        const div = document.createElement("div");
        div.className = "playerCard bg-white p-3 rounded-lg shadow border-l-4 min-w-[160px]"; 
        div.style.borderLeftColor = getPlayerColor(index);
        div.innerHTML = `
            <div class="flex items-center mb-1">
                <span class="text-2xl mr-2">${player.icon}</span>
                <strong class="text-lg">${player.name}</strong>
            </div>
            <div>Dinero: <span class="font-semibold">$${player.money}</span></div>
            <div>Vueltas: <span class="font-semibold">${player.laps} / 2</span></div>
            <div class="text-sm text-gray-600 mt-1">Aciertos: ${player.correct} | Errores: ${player.wrong}</div>`;
        playersStatusDiv.appendChild(div);
      });
    }

    function triggerChallenge(player) {
      const questions = [
         { question: "¬øQu√© es un 'presupuesto' y por qu√© es importante?", options: ["Un plan de gastos futuros", "Una lista de deseos", "Un tipo de inversi√≥n"], correctIndex: 0, reward: 100, penalty: 50 },
         { question: "¬øCu√°l es una forma de generar 'ingresos pasivos'?", options: ["Trabajar horas extra", "Alquilar una propiedad", "Gastar menos"], correctIndex: 1, reward: 120, penalty: 60 },
         { question: "Verdadero o Falso: Ahorrar un peque√±o porcentaje de tus ingresos no hace gran diferencia a largo plazo.", options: ["Verdadero", "Falso"], correctIndex: 1, reward: 80, penalty: 40 },
      ];
      const questionData = questions[Math.floor(Math.random() * questions.length)];
      questionEl.textContent = questionData.question;
      optionsEl.innerHTML = "";
      questionData.options.forEach((option, index) => {
        const btn = document.createElement("button");
        btn.textContent = option;
        btn.className = "block w-full text-left bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-2 px-4 border border-blue-300 rounded shadow transition duration-150 ease-in-out";
        btn.onclick = () => {
          challengeModal.style.display = "none";
          if (index === questionData.correctIndex) {
            player.money += questionData.reward; player.correct++;
            showMessage(`${player.name} acert√≥ y gan√≥ $${questionData.reward}!`, 'success');
          } else {
            player.money -= questionData.penalty; player.wrong++;
            showMessage(`${player.name} fall√≥ y perdi√≥ $${questionData.penalty}. Correcta: ${questionData.options[questionData.correctIndex]}`, 'danger');
          }
          updateStatus();
          setTimeout(nextTurn, 1500);
        };
        optionsEl.appendChild(btn);
      });
      challengeModal.style.display = "flex";
    }

     function handleSurprise(player) {
        const surprises = [
            { message: "¬°Devoluci√≥n de impuestos inesperada!", amount: 100, type: 'success' },
            { message: "¬°Reparaci√≥n urgente del coche!", amount: -70, type: 'warning' },
            { message: "¬°Ganaste un peque√±o premio online!", amount: 50, type: 'success' },
            { message: "¬°Multa por biblioteca!", amount: -20, type: 'danger' },
        ];
        const surprise = surprises[Math.floor(Math.random() * surprises.length)];
        player.money += surprise.amount;
        showMessage(`${player.name}: ${surprise.message} (${surprise.amount > 0 ? '+' : ''}$${surprise.amount})`, surprise.type);
        updateStatus();
        setTimeout(nextTurn, 1500); 
    }

    function showMessage(text, type = 'info') {
        const msgContainer = document.getElementById('message-container') || createMessageContainer();
        const msgDiv = document.createElement("div");
        let bgColor = 'bg-blue-500';
        if (type === 'success') bgColor = 'bg-green-500';
        if (type === 'warning') bgColor = 'bg-yellow-500 text-black'; 
        if (type === 'danger') bgColor = 'bg-red-500';
        msgDiv.className = `w-auto max-w-md ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg text-sm z-50 mb-2 transition-all duration-300 ease-out opacity-0 transform translate-y-2`;
        msgDiv.textContent = text;
        msgContainer.prepend(msgDiv);
        setTimeout(() => { msgDiv.style.opacity = '1'; msgDiv.style.transform = 'translate-y(0)';}, 10);
        setTimeout(() => {
            msgDiv.style.opacity = '0'; msgDiv.style.transform = 'translate-y(-10px)'; 
            setTimeout(() => msgDiv.remove(), 300); 
        }, 4000);
    }
    
    function createMessageContainer() {
        let container = document.getElementById('message-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'message-container';
            container.className = 'fixed bottom-5 left-1/2 transform -translate-x-1/2 flex flex-col items-center z-[100]'; 
            document.body.appendChild(container);
        }
        return container;
    }

    if(startButton) startButton.addEventListener("click", startGame);
    renderBoard(); 
    mostrarPestana('inicio'); 
    addPlayerInput(); 
  </script>
</body>
</html>
